# CLI приложение с флуд-контролем

## Общие требования

Реализовать интерфейс с методом для проверки правил флуд-контроля. Если за последние N секунд вызовов метода Check будет больше K, значит, проверка на флуд-контроль не пройдена.

- Интерфейс FloodControl располагается в файле main.go.

- Флуд-контроль может быть запущен на нескольких экземплярах приложения одновременно, поэтому нужно предусмотреть общее хранилище данных. Допустимо использовать любое. 

- (*) Добавить поддержку конфигурации итоговой реализации. Параметры — на усмотрение разработчика.

## Описание реализации

1. Для удобства проверки работы реализованного интерфейса FloodControl:

    - реализовано CLI приложение с возможностью выполнения команд `check` (вызов метода Check интерфейса FloodControl) и `exit` (выход из программы);

    - реализация интерфейса FloodControl располагается в директории _internal/domains/flood_;

    - добавлена поддержка конфигурации, добавлены параметры пути к базе данных, периода и ограничения количества вызовов в течение этого периода, ID пользователя;

    - реализована инициализация БД, при выполнении которой использованы миграции для удобного управления версиями БД и сохранения консистентности при её переносе;

    - использован логгер для обработки и отслеживания работы приложения во время его реализации и выполнения;

    - использован линтер golangci-lint для анализа кода на разного рода ошибки в ходе его написания.

2. Реализация интерфейса FloodControl состоит из частей сервиса и репозитория:
   
    - сервис FloodController, реализующий интерфейс FloodControl, отвечает за проверку количества вызовов за указанный период после вызова метода репозитория;
    
    - репозиторий отвечает за добавление информации о новом вызове в хранилище и подсчёта количества вызовов за последние N секунд. В качестве СУБД выбран PostgreSQL;

    - для интерфейсов FloodControl и Repository сгенерированы моки, расположенные в директории _internal/mocks_.

3. Сервис FloodController блокирует вызов метода Check с помощью примитива синхронизации sync.Mutex, чтобы во время выполнения запросов к БД и подсчёта количества вызовов метод не был выполнен со стороны других потоков приложения.

4. Реализация репозитория:

    - В методе репозитория используется транзакция для того, чтобы во время выполнения отдельных запросов к БД данные не были изменены со стороны другого экземпляра приложения, а также в случае ошибки при выполнении запросов в текущей транзакции происходил откат до момента её начала.

    - При добавлении информации о новом вызове текущее время добавляется автоматически, на уровне БД, чтобы зафиксировать именно время сохранения данных в БД и в дальнейшем проверять их непосредственно при запросе к БД.
  
    - При работе с БД использованы индексы для ID пользователя и времени создания записи о вызове для ускорения процесса поиска строк.

    - Период времени, в течение которого проверяется ограничение количества запросов, также формируется при выполнении запроса к БД.

5. Следующие возможные шаги:

    - реализовать процедуру регистрации и авторизации для пользователя;

    - построить новую таблицу в БД для пользователей и сделать внешний ключ на ID пользователя из таблицы flood;

    - покрыть код unit и интеграционными тестами.

## Запуск

Вывести список всех возможных команд:

`make help`

Запустить приложение:

`make run`

Сформировать документацию:

`make doc`

***Изменить значения флагов возможно в первых строках Makefile.***


